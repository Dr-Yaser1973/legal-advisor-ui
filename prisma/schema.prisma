generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                         Int                   @id @default(autoincrement())
  name                       String?
  email                      String?               @unique
  emailVerified              DateTime?
  image                      String?
  password                   String?
  role                       UserRole              @default(CLIENT)
  createdAt                  DateTime              @default(now())
  updatedAt                  DateTime              @updatedAt
  isApproved                 Boolean               @default(false)
  location                   String?
  phone                      String?
  status                     UserStatus            @default(PENDING)
  subscriptionEndsAt         DateTime?
  accounts                   Account[]
  AnalysisJob                AnalysisJob[]
  auditLogs                  AuditLog[]
  cases                      Case[]
  ClientChatRooms            ChatRoom[]            @relation("ClientChatRooms")
  LawyerChatRooms            ChatRoom[]            @relation("LawyerChatRooms")
  clientProfile              ClientProfile?
  consultations              Consultation[]
  LawyerConsultationRequests ConsultationRequest[] @relation("LawyerConsultationRequests")
  ClientConsultationRequests ConsultationRequest[] @relation("ClientConsultationRequests")
  ContractTemplate           ContractTemplate[]
  GeneratedContract          GeneratedContract[]
  LawyerConsultOffers        HumanConsultOffer[]
  ClientHumanConsults        HumanConsultRequest[] @relation("ClientHumanConsults")
  LawyerHumanConsults        HumanConsultRequest[] @relation("LawyerHumanConsults")
  LawDocs                    LawDoc[]
  lawyerProfile              LawyerProfile?
  LegalQuestion              LegalQuestion[]       @relation("UserQuestions")
  messages                   Message[]
  notifications              Notification[]
  sessions                   Session[]
  TranslationOffers          TranslationOffer[]
  ClientTranslationRequests  TranslationRequest[]  @relation("ClientTranslationRequests")
  OfficeTranslationRequests  TranslationRequest[]  @relation("OfficeTranslationRequests")
}

model Account {
  id                Int     @id @default(autoincrement())
  userId            Int
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           Int      @id @default(autoincrement())
  sessionToken String   @unique
  userId       Int
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model LawyerProfile {
  id              Int           @id @default(autoincrement())
  userId          Int           @unique
  bio             String?
  specialties     String?
  phone           String?
  city            String?
  rating          Float?
  consultCurrency String?       @default("IQD")
  consultFee      Int?
  officeAddress   String?
  avatarPath      String?
  appointments    Appointment[]
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([city])
}

model ClientProfile {
  id           Int           @id @default(autoincrement())
  userId       Int           @unique
  phone        String?
  city         String?
  appointments Appointment[]
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([city])
}

model Appointment {
  id       Int           @id @default(autoincrement())
  lawyerId Int
  clientId Int
  startsAt DateTime
  endsAt   DateTime
  subject  String
  location String?
  notes    String?
  client   ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  lawyer   LawyerProfile @relation(fields: [lawyerId], references: [id], onDelete: Cascade)

  @@index([lawyerId, startsAt])
  @@index([clientId, startsAt])
}

model Notification {
  id        Int       @id @default(autoincrement())
  userId    Int
  title     String
  body      String?
  readAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, readAt])
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    Int?
  action    String
  meta      Json?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
}

model LegalQuestion {
  id               Int                @id @default(autoincrement())
  slug             String?            @unique
  question_text    String
  answer_text      String
  category         String?
  language         Language?
  jurisdiction     String?
  source_reference String?
  status           DocStatus          @default(PUBLISHED)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  createdById      Int?
  createdBy        User?              @relation("UserQuestions", fields: [createdById], references: [id])
  tags             LegalQuestionTag[]
  references       LegalReference[]
  embedding        QuestionEmbedding?
  consultations    Consultation[]     @relation("ConsultationToLegalQuestion")

  @@index([category])
  @@index([jurisdiction])
  @@index([status, createdAt])
}

model QuestionEmbedding {
  id              Int           @id @default(autoincrement())
  legalQuestionId Int           @unique
  embedding       Float[]
  legalQuestion   LegalQuestion @relation(fields: [legalQuestionId], references: [id], onDelete: Cascade)
}

model Tag {
  id   Int                @id @default(autoincrement())
  name String             @unique
  qs   LegalQuestionTag[]
  docs TagOnDoc[]

  @@index([name])
}

model LegalQuestionTag {
  questionId Int
  tagId      Int
  question   LegalQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  tag        Tag           @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([questionId, tagId])
}

model LegalReference {
  id           Int           @id @default(autoincrement())
  questionId   Int
  title        String?
  cite         String?
  url          String?
  year         Int?
  jurisdiction String?
  question     LegalQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model LegalDocument {
  id                  Int                  @id @default(autoincrement())
  title               String
  filename            String?
  mimetype            String
  size                Int
  createdAt           DateTime             @default(now())
  filePath            String?
  AnalysisJobs        AnalysisJob[]
  CaseDocument        CaseDocument[]
  generatedContracts  GeneratedContract[]
  chunks              LegalDocChunk[]
  TranslationRequests TranslationRequest[]
  lawUnits            LawUnitDocument[]
}

model LegalDocChunk {
  id         Int             @id @default(autoincrement())
  documentId Int
  idx        Int
  text       String
  embedding  ChunkEmbedding?
  document   LegalDocument   @relation(fields: [documentId], references: [id], onDelete: Cascade)
}

model ChunkEmbedding {
  id        Int           @id @default(autoincrement())
  chunkId   Int           @unique
  embedding Float[]
  chunk     LegalDocChunk @relation(fields: [chunkId], references: [id], onDelete: Cascade)
}

model Consultation {
  id            Int                   @id @default(autoincrement())
  title         String
  description   String
  userId        Int
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  answer        String?
  user          User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  humanRequests HumanConsultRequest[]
  legalRefs     LegalQuestion[]       @relation("ConsultationToLegalQuestion")
}

model Case {
  id          Int            @id @default(autoincrement())
  title       String
  description String
  type        String
  court       String
  status      String
  filingDate  DateTime
  closingDate DateTime?
  parties     Json
  notes       String?
  aiAnalysis  Json?
  userId      Int
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents   CaseDocument[]
  events      CaseEvent[]

  @@index([status])
  @@index([type])
  @@index([filingDate])
}

model CaseEvent {
  id     Int      @id @default(autoincrement())
  caseId Int
  title  String
  date   DateTime
  note   String?
  case   Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
}

model CaseDocument {
  caseId     Int
  documentId Int
  case       Case          @relation(fields: [caseId], references: [id], onDelete: Cascade)
  document   LegalDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@id([caseId, documentId])
}

model ContractTemplate {
  id          Int                 @id @default(autoincrement())
  slug        String              @unique
  title       String
  bodyHtml    String
  language    Language            @default(AR)
  createdById Int?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  createdBy   User?               @relation(fields: [createdById], references: [id])
  generated   GeneratedContract[]
}

model GeneratedContract {
  id          Int               @id @default(autoincrement())
  templateId  Int?
  sourceDocId Int?
  title       String
  partyA      String?
  partyB      String?
  subject     String?
  pdfPath     String
  data        Json?
  createdById Int?
  createdAt   DateTime          @default(now())
  createdBy   User?             @relation(fields: [createdById], references: [id])
  sourceDoc   LegalDocument?    @relation(fields: [sourceDocId], references: [id])
  template    ContractTemplate? @relation(fields: [templateId], references: [id])
}

model AnalysisJob {
  id          Int              @id @default(autoincrement())
  userId      Int
  filename    String
  mimetype    String?
  size        Int?
  status      JobStatus        @default(QUEUED)
  startedAt   DateTime?
  finishedAt  DateTime?
  error       String?
  sourceDocId Int?
  createdAt   DateTime         @default(now())
  sourceDoc   LegalDocument?   @relation(fields: [sourceDocId], references: [id])
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  outputs     AnalysisOutput[]

  @@index([userId, status, createdAt])
}

model AnalysisOutput {
  id        Int         @id @default(autoincrement())
  jobId     Int
  kind      String
  content   Json
  createdAt DateTime    @default(now())
  job       AnalysisJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
}

model LawDoc {
  id           Int          @id @default(autoincrement())
  title        String
  jurisdiction String
  year         Int?
  sourceUrl    String?
  filePath     String?
  pagesCount   Int?
  checksum     String?      @unique
  text         String?
  visibility   String       @default("PUBLIC")
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  createdById  Int?
  category     LawCategory
  articles     LawArticle[]
  createdBy    User?        @relation(fields: [createdById], references: [id])
  tags         TagOnDoc[]
  faqs  LawDocFaq[]

  @@index([category])
  @@index([jurisdiction])
}

model LawArticle {
  id        Int      @id @default(autoincrement())
  ordinal   Int
  text      String
  createdAt DateTime @default(now())
  lawDocId  Int
  number    String?
  lawDoc    LawDoc   @relation(fields: [lawDocId], references: [id], onDelete: Cascade)
}

model TagOnDoc {
  docId Int
  tagId Int
  doc   LawDoc @relation(fields: [docId], references: [id], onDelete: Cascade)
  tag   Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([docId, tagId])
}

model HumanConsultRequest {
  id             Int                 @id @default(autoincrement())
  consultationId Int?
  clientId       Int
  lawyerId       Int?
  status         HumanConsultStatus  @default(PENDING)
  createdAt      DateTime            @default(now())
  acceptedAt     DateTime?
  completedAt    DateTime?
  chatRoom       ChatRoom?
  offers         HumanConsultOffer[]
  client         User                @relation("ClientHumanConsults", fields: [clientId], references: [id], onDelete: Cascade)
  consultation   Consultation?       @relation(fields: [consultationId], references: [id], onDelete: Cascade)
  lawyer         User?               @relation("LawyerHumanConsults", fields: [lawyerId], references: [id])
}

model HumanConsultOffer {
  id        Int                 @id @default(autoincrement())
  requestId Int
  lawyerId  Int
  fee       Int
  currency  String              @default("IQD")
  note      String?
  status    String              @default("PENDING")
  createdAt DateTime            @default(now())
  lawyer    User                @relation(fields: [lawyerId], references: [id], onDelete: Cascade)
  request   HumanConsultRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@index([lawyerId])
}

model ChatRoom {
  id        Int                 @id @default(autoincrement())
  requestId Int                 @unique
  clientId  Int
  lawyerId  Int
  createdAt DateTime            @default(now())
  client    User                @relation("ClientChatRooms", fields: [clientId], references: [id], onDelete: Cascade)
  lawyer    User                @relation("LawyerChatRooms", fields: [lawyerId], references: [id], onDelete: Cascade)
  request   HumanConsultRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  messages  Message[]
}

model Message {
  id        Int      @id @default(autoincrement())
  roomId    Int
  senderId  Int
  text      String
  createdAt DateTime @default(now())
  room      ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  sender    User     @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([roomId])
  @@index([senderId])
}

model ConsultationRequest {
  id        Int      @id @default(autoincrement())
  userId    Int
  lawyerId  Int?
  status    String   @default("PENDING")
  message   String
  createdAt DateTime @default(now())
  lawyer    User?    @relation("LawyerConsultationRequests", fields: [lawyerId], references: [id])
  user      User     @relation("ClientConsultationRequests", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lawyerId])
  @@index([status, createdAt])
}

model TranslationRequest {
  id                 Int                @id @default(autoincrement())
  clientId           Int
  officeId           Int?
  sourceDocId        Int
  targetLang         Language
  status             TranslationStatus  @default(PENDING)
  note               String?
  price              Int?
  currency           String?            @default("IQD")
  createdAt          DateTime           @default(now())
  acceptedAt         DateTime?
  completedAt        DateTime?
  deliveredAt        DateTime?
  receivedAt         DateTime?
  translatedFilePath String?
  translatedFileUrl  String?
  offers             TranslationOffer[]
  client             User               @relation("ClientTranslationRequests", fields: [clientId], references: [id], onDelete: Cascade)
  office             User?              @relation("OfficeTranslationRequests", fields: [officeId], references: [id])
  sourceDoc          LegalDocument      @relation(fields: [sourceDocId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([officeId])
  @@index([status, createdAt])
}

model TranslationOffer {
  id        Int                @id @default(autoincrement())
  requestId Int
  officeId  Int
  price     Int
  currency  String             @default("IQD")
  note      String?
  status    String             @default("PENDING")
  createdAt DateTime           @default(now())
  office    User               @relation(fields: [officeId], references: [id], onDelete: Cascade)
  request   TranslationRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@index([officeId])
}

enum DocStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum Language {
  AR
  EN
}

enum LawCategory {
  LAW
  FIQH
  ACADEMIC_STUDY
}

enum UserRole {
  ADMIN
  LAWYER
  CLIENT
  COMPANY
  TRANSLATION_OFFICE
}

enum JobStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
}

enum HumanConsultStatus {
  PENDING
  ACCEPTED
  IN_PROGRESS
  COMPLETED
  CANCELED
}

enum TranslationStatus {
  PENDING
  ACCEPTED
  IN_PROGRESS
  COMPLETED
  CANCELED
}

enum UserStatus {
  ACTIVE
  PENDING
  SUSPENDED
  EXPIRED
}

enum LawRelationType {
  AMENDS // يعدّل
  REPEALS // يلغي
  INTERPRETS // يفسّر
  REFERENCES // إحالة
  RELATED // صلة عامة
  APPLIES_TO // ينطبق على
}

model LawUnitDocument {
  id         Int @id @default(autoincrement())
  lawUnitId  Int
  documentId Int

  lawUnit  LawUnit       @relation(fields: [lawUnitId], references: [id], onDelete: Cascade)
  document LegalDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([lawUnitId, documentId])
  @@index([lawUnitId])
  @@index([documentId])
}

model LawUnit {
  id           Int     @id @default(autoincrement())
  title        String
  content      String
  simplified   String?
  practicalUse String?

  category LawCategory
  status   DocStatus

  relationsFrom LawRelation[] @relation("FromLawUnit")
  relationsTo   LawRelation[] @relation("ToLawUnit")

  documents LawUnitDocument[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([status])
}

model LawRelation {
  id     Int             @id @default(autoincrement())
  fromId Int
  toId   Int
  type   LawRelationType
  note   String?

  from LawUnit @relation("FromLawUnit", fields: [fromId], references: [id], onDelete: Cascade)
  to   LawUnit @relation("ToLawUnit", fields: [toId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([fromId, toId, type])
  @@index([fromId])
  @@index([toId])
}
model LawDocFaq {
  id        Int      @id @default(autoincrement())
  docId     Int
  question  String
  answer    String

  doc       LawDoc   @relation(fields: [docId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([docId])
}
